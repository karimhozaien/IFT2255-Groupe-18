<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">untitled</a> &gt; <a href="index.source.html" class="el_package">com.maville.controller.repository</a> &gt; <span class="el_source">WorkRepository.java</span></div><h1>WorkRepository.java</h1><pre class="source lang-java linenums">package com.maville.controller.repository;

import com.maville.controller.services.ApisManager;
import com.maville.controller.services.*;
import com.maville.model.Project;
import com.maville.model.Project.TypeOfWork;
import com.maville.model.WorkRequestForm;
import com.squareup.moshi.Json;
import com.squareup.moshi.JsonAdapter;
import com.squareup.moshi.Moshi;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.*;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Dépôt pour gérer les données liées aux projets et aux entraves.
 * Fournit des fonctionnalités pour récupérer, filtrer et stocker des informations provenant
 * d'APIs externes ou de la base de données locale.
 */
<span class="fc" id="L24">public class WorkRepository {</span>
<span class="fc" id="L25">    public static String worksAPI = &quot;https://donnees.montreal.ca/api/3/action/datastore_search?resource_id=cc41b532-f12d-40fb-9f55-eb58c9a2b12b&quot;;</span>
<span class="fc" id="L26">    public static String roadObstructionsAPI = &quot;https://donnees.montreal.ca/api/3/action/datastore_search?resource_id=a2bc8014-488c-495d-941b-e7ae1999d1bd&quot;;</span>

    /**
     * Récupère les enregistrements à partir d'une réponse JSON.
     *
     * @param jsonResponse La chaîne JSON à analyser.
     * @return Une liste de {@code Result.Record} contenant les données des enregistrements.
     * @throws IOException Si le JSON est invalide ou incomplet.
     */
    public List&lt;Result.Record&gt; getRecords(String jsonResponse) throws IOException {
<span class="fc" id="L36">        Moshi moshi = new Moshi.Builder().build();</span>
<span class="fc" id="L37">        JsonAdapter&lt;ApiResponse&gt; jsonAdapter = moshi.adapter(ApiResponse.class);</span>
<span class="fc" id="L38">        ApiResponse apiResponse = jsonAdapter.fromJson(jsonResponse);</span>

<span class="pc bpc" id="L40" title="3 of 6 branches missed.">        if (apiResponse == null || apiResponse.result == null || apiResponse.result.records == null) {</span>
<span class="nc" id="L41">            throw new IOException(&quot;JSON invalide : Les variables 'result' ou 'records' sont manquantes/inexistantes.&quot;);</span>
        }
<span class="fc" id="L43">        return apiResponse.result.records;</span>
    }

    private &lt;T&gt; List&lt;T&gt; fetchAndParseRecords(String apiUrl, String option, Class&lt;T&gt; type) throws IOException {
<span class="fc" id="L47">        ApiClient apiClient = new ApiClient();</span>
<span class="fc" id="L48">        apiClient.connect(apiUrl); // Connection à l'API</span>

<span class="fc" id="L50">        List&lt;Result.Record&gt; records = getRecords(apiClient.getJsonResponse());</span>
<span class="fc" id="L51">        Parser&lt;T&gt; parser = new Parser&lt;&gt;(records);</span>
<span class="fc" id="L52">        return parser.initializeParsing(option, type);</span>
    }

    /**
     * Récupère la liste des projets en cours depuis l'API des travaux.
     *
     * @return Une liste de {@code Project} représentant les projets en cours.
     * @throws IOException Si une erreur se produit lors de la récupération ou du traitement des données.
     */
    public List&lt;Project&gt; getOngoingProjects() throws IOException {
<span class="fc" id="L62">        return fetchAndParseRecords(worksAPI, &quot;works&quot;, Project.class);</span>
    }

    /**
     * Récupère la liste des entraves routières depuis l'API des entraves.
     *
     * @return Une liste de chaînes représentant les entraves routières.
     * @throws IOException Si une erreur se produit lors de la récupération ou du traitement des données.
     */
    public List&lt;String&gt; getRoadObstructions() throws IOException {
<span class="nc" id="L72">        return fetchAndParseRecords(roadObstructionsAPI, &quot;road_obstructions&quot;, String.class);</span>
    }

    /**
     * Récupère une liste filtrée d'entraves routières selon un critère donné.
     *
     * @param criteria Le type de critère (ex. &quot;rue&quot;).
     * @param criteriaField La valeur du critère (ex. nom de rue).
     * @return Une liste de chaînes représentant les entraves filtrées.
     * @throws IOException Si une erreur se produit lors du traitement des données.
     */
    public List&lt;String&gt; getFilteredRoadObstructions(String criteria, String criteriaField) throws IOException {
<span class="nc" id="L84">        return parseItems(criteria, criteriaField, null, String.class);</span>
    }

    /**
     * Récupère une liste filtrée de projets selon un critère donné.
     *
     * @param criteria Le type de critère (ex. &quot;quartier&quot;, &quot;travail&quot;).
     * @param criteriaField La valeur du critère (ex. nom de quartier).
     * @return Une liste de {@code Project} représentant les projets filtrés.
     * @throws IOException Si une erreur se produit lors du traitement des données.
     */
    public List&lt;Project&gt; getFilteredProjects(String criteria, String criteriaField, List&lt;Project&gt; projects) throws IOException {
<span class="fc" id="L96">        return parseItems(criteria, criteriaField, projects, Project.class);</span>
    }

    /**
     * Récupère une liste filtrée de projets selon un terme de recherche donné.
     *
     * @param searchTerm Le terme de recherche (titre, quartier, type de travaux).
     * @return Une liste de {@code Project} correspondant au terme recherché.
     * @throws IOException Si une erreur se produit lors du traitement des données.
     */
    public List&lt;Project&gt; getFilteredProjects(String searchTerm) throws IOException {
<span class="nc" id="L107">        List&lt;Project&gt; filteredProjects = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L108">        searchTerm = TextUtil.removeAccents(searchTerm).toLowerCase(); // Retirer les accents</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (Project project : getOngoingProjects()) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (project.getTitle().toLowerCase().contains(searchTerm) ||</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    project.getAffectedNeighbourhood().toLowerCase().contains(searchTerm) ||</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    project.getTypeOfWork().toString().toLowerCase().contains(searchTerm)) {</span>
<span class="nc" id="L114">                filteredProjects.add(project);</span>
            }
<span class="nc" id="L116">        }</span>
<span class="nc" id="L117">        return filteredProjects;</span>
    }

    /**
     * Récupère tous les projets, y compris ceux en cours et planifiés.
     *
     * @return Une liste de {@code Project} représentant tous les projets.
     * @throws IOException Si une erreur se produit lors de la récupération ou du traitement des données.
     */
    public List&lt;Project&gt; getAllProjects() throws IOException {
<span class="fc" id="L127">        List&lt;Project&gt; allProjects = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L128">        allProjects.addAll(getOngoingProjects());</span>
<span class="fc" id="L129">        allProjects.addAll(getPlannedProjects());</span>
<span class="fc" id="L130">        return allProjects;</span>
    }

    /**
     * Récupère les projets planifiés depuis la base de données locale.
     *
     * @return Une liste de {@code Project} représentant les projets planifiés.
     */
    public List&lt;Project&gt; getPlannedProjects() {
<span class="fc" id="L139">        return fetchPlannedProjects();</span>
    }

    private &lt;T&gt; List&lt;T&gt; parseItems(String criteria, String criteriaField, List&lt;Project&gt; projects, Class&lt;T&gt; type) throws IOException {
<span class="fc" id="L143">        List&lt;T&gt; filteredItems = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (type.equals(Project.class)) {</span>
            // Utilisez la liste passée en paramètre ou récupérez tous les projets
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            List&lt;Project&gt; sourceProjects = (projects != null) ? projects : getAllProjects();</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">            for (Project project : sourceProjects) {</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                if (criteria.equals(&quot;quartier&quot;)) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    if (project.getAffectedNeighbourhood().toLowerCase().contains(criteriaField.toLowerCase())) {</span>
<span class="nc" id="L152">                        filteredItems.add(type.cast(project));</span>
                    }
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                } else if (criteria.equals(&quot;travail&quot;)) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if (project.getTypeOfWork().equals(TypeOfWork.valueOf(criteriaField))) {</span>
<span class="nc" id="L156">                        filteredItems.add(type.cast(project));</span>
                    }
                }
<span class="fc" id="L159">            }</span>
<span class="pc bnc" id="L160" title="All 2 branches missed.">        } else if (type.equals(String.class)) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (criteria.equals(&quot;rue&quot;)) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                for (String roadObsutruction : getRoadObstructions()) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    if (roadObsutruction.toLowerCase().contains(criteriaField.toLowerCase())) {</span>
<span class="nc" id="L164">                        filteredItems.add(type.cast(roadObsutruction.split(&quot;\\. &quot;)[1]));</span>
                    }
<span class="nc" id="L166">                }</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            } else if (criteria.equals(&quot;travail&quot;)) {</span>
                try {
<span class="nc" id="L169">                    ApisManager apisManager = new ApisManager();</span>
<span class="nc" id="L170">                    List&lt;List&lt;String&gt;&gt; filteredRoadObstructions = apisManager.parallelComputingForRequests(TypeOfWork.valueOf(criteriaField));</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    for (List&lt;String&gt; filteredRoadObstruction : filteredRoadObstructions) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                        for (String s : filteredRoadObstruction) {</span>
<span class="nc" id="L173">                            filteredItems.add(type.cast(s));</span>
<span class="nc" id="L174">                        }</span>
<span class="nc" id="L175">                    }</span>
<span class="nc" id="L176">                } catch (Exception e) {</span>
<span class="nc" id="L177">                    throw new RuntimeException(e);</span>
<span class="nc" id="L178">                }</span>
            }
        }

<span class="fc" id="L182">        return filteredItems;</span>
    }

    /**
     * Récupère tous les projets planifiés depuis la base de données locale.
     *
     * @return Une liste de {@code Project} représentant les projets planifiés.
     *         Retourne {@code null} si aucune donnée n'est trouvée ou en cas d'erreur.
     */
    public List&lt;Project&gt; fetchPlannedProjects() {
<span class="fc" id="L192">        List&lt;Project&gt; plannedProjects = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L193">        String selectSQL = &quot;SELECT * FROM Projects&quot;;</span>

<span class="fc" id="L195">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="fc" id="L196">             PreparedStatement pstmt = conn.prepareStatement(selectSQL)) {</span>

<span class="fc" id="L198">            try (ResultSet rs = pstmt.executeQuery()) {</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L200">                    String idFromDB = rs.getString(&quot;id&quot;);</span>
<span class="fc" id="L201">                    String titleFromDB = rs.getString(&quot;title&quot;);</span>
<span class="fc" id="L202">                    String descriptionFromDB = rs.getString(&quot;description&quot;);</span>
<span class="fc" id="L203">                    String typeOfWorkRawFromDB = rs.getString(&quot;type_of_work&quot;);</span>
<span class="fc" id="L204">                    String affectedNeighbourhoodFromDB = rs.getString(&quot;affected_neighbourhood&quot;);</span>
<span class="fc" id="L205">                    String affectedStreetsFromDB = rs.getString(&quot;affected_streets&quot;);</span>
<span class="fc" id="L206">                    String startDateFromDB = rs.getString(&quot;start_date&quot;);</span>
<span class="fc" id="L207">                    String endDateFromDB = rs.getString(&quot;end_date&quot;);</span>
<span class="fc" id="L208">                    String workScheduleFromDB = rs.getString(&quot;work_schedule&quot;);</span>
<span class="fc" id="L209">                    String workStatusFromDB = rs.getString(&quot;work_status&quot;);</span>

<span class="fc" id="L211">                    Project project = new Project(</span>
                            idFromDB,
                            titleFromDB,
                            descriptionFromDB,
<span class="fc" id="L215">                            Project.TypeOfWork.valueOf(typeOfWorkRawFromDB),</span>
                            affectedNeighbourhoodFromDB,
                            affectedStreetsFromDB,
                            startDateFromDB,
                            endDateFromDB,
                            workScheduleFromDB,
<span class="fc" id="L221">                            Project.WorkStatus.valueOf(workStatusFromDB)</span>
                    );
<span class="fc" id="L223">                    plannedProjects.add(project);</span>
<span class="fc" id="L224">                }</span>

<span class="pc bpc" id="L226" title="1 of 2 branches missed.">                if (plannedProjects.isEmpty()) {</span>
<span class="nc" id="L227">                    System.out.println(&quot;Erreur lors du fetching.&quot;);</span>
<span class="nc" id="L228">                    return null;</span>
                }

<span class="fc" id="L231">                return plannedProjects;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L234">            System.out.println(&quot;Erreur lors de la connexion à la DB : &quot; + e.getMessage());</span>
<span class="nc" id="L235">            return null;</span>
        }
    }

    public List&lt;Project&gt; getPlannedProjectsWithinThreeMonths() {
<span class="nc" id="L240">        List&lt;Project&gt; plannedProjects = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L241">        String selectSQL = &quot;SELECT * FROM Projects WHERE DATE(start_date) &lt;= DATE('now', '+3 months')&quot;;</span>

<span class="nc" id="L243">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="nc" id="L244">             PreparedStatement pstmt = conn.prepareStatement(selectSQL)) {</span>

<span class="nc" id="L246">            try (ResultSet rs = pstmt.executeQuery()) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L248">                    String id = rs.getString(&quot;id&quot;);</span>
<span class="nc" id="L249">                    String title = rs.getString(&quot;title&quot;);</span>
<span class="nc" id="L250">                    String description = rs.getString(&quot;description&quot;);</span>
<span class="nc" id="L251">                    String typeOfWork = rs.getString(&quot;type_of_work&quot;);</span>
<span class="nc" id="L252">                    String affectedNeighbourhood = rs.getString(&quot;affected_neighbourhood&quot;);</span>
<span class="nc" id="L253">                    String affectedStreets = rs.getString(&quot;affected_streets&quot;);</span>
<span class="nc" id="L254">                    String startDate = rs.getString(&quot;start_date&quot;);</span>
<span class="nc" id="L255">                    String endDate = rs.getString(&quot;end_date&quot;);</span>
<span class="nc" id="L256">                    String workSchedule = rs.getString(&quot;work_schedule&quot;);</span>
<span class="nc" id="L257">                    String workStatus = rs.getString(&quot;work_status&quot;);</span>

<span class="nc" id="L259">                    Project project = new Project(</span>
                            id,
                            title,
                            description,
<span class="nc" id="L263">                            Project.TypeOfWork.valueOf(typeOfWork),</span>
                            affectedNeighbourhood,
                            affectedStreets,
                            startDate,
                            endDate,
                            workSchedule,
<span class="nc" id="L269">                            Project.WorkStatus.valueOf(workStatus)</span>
                    );
<span class="nc" id="L271">                    plannedProjects.add(project);</span>
<span class="nc" id="L272">                }</span>
            }
<span class="nc" id="L274">        } catch (SQLException e) {</span>
<span class="nc" id="L275">            System.out.println(&quot;Erreur lors de la récupération des projets planifiés : &quot; + e.getMessage());</span>
<span class="nc" id="L276">        }</span>
<span class="nc" id="L277">        return plannedProjects;</span>
    }

    /**
     * Enregistre un projet planifié dans la base de données locale.
     *
     * @param project Le projet à enregistrer.
     */
    public void savePlannedProject(Project project) {
<span class="fc" id="L286">        String insertSQL = &quot;INSERT INTO Projects(id, title, description, type_of_work, affected_neighbourhood, &quot; +</span>
                &quot;affected_streets, start_date, end_date, work_schedule, work_status) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;

<span class="fc" id="L289">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="fc" id="L290">            PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {</span>

<span class="fc" id="L292">            pstmt.setString(1, project.getId());</span>
<span class="fc" id="L293">            pstmt.setString(2, project.getTitle());</span>
<span class="fc" id="L294">            pstmt.setString(3, project.getDescription());</span>
<span class="fc" id="L295">            pstmt.setString(4, project.getTypeOfWork().toString());</span>
<span class="fc" id="L296">            pstmt.setString(5, project.getAffectedNeighbourhood());</span>
<span class="fc" id="L297">            pstmt.setString(6, project.getAffectedStreets());</span>
<span class="fc" id="L298">            pstmt.setString(7, project.getStartDate());</span>
<span class="fc" id="L299">            pstmt.setString(8, project.getEndDate());</span>
<span class="fc" id="L300">            pstmt.setString(9, project.getWorkSchedule());</span>
<span class="fc" id="L301">            pstmt.setString(10, project.getWorkStatus().toString());</span>

<span class="fc" id="L303">            pstmt.executeUpdate();</span>
            //System.out.println(&quot;Le projet a été sauvegardée.&quot;); // Message helper
<span class="nc" id="L305">        } catch (SQLException e) {</span>
<span class="nc" id="L306">            System.out.println(&quot;Erreur lors de l'enregistrement du projet : &quot; + e.getMessage());</span>
<span class="fc" id="L307">        }</span>
<span class="fc" id="L308">    }</span>

    /**
     * Met à jour un projet planifié existant dans la base de données locale.
     *
     * @param project Le projet à mettre à jour.
     */
    public void updatePlannedProject(Project project) {
<span class="nc" id="L316">        String updateSQL = &quot;UPDATE Projects SET title = ?, description = ?, type_of_work = ?, &quot; +</span>
                &quot;affected_neighbourhood = ?, affected_streets = ?, start_date = ?, end_date = ?, &quot; +
                &quot;work_schedule = ?, work_status = ? WHERE id = ?&quot;;

<span class="nc" id="L320">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="nc" id="L321">             PreparedStatement pstmt = conn.prepareStatement(updateSQL)) {</span>

<span class="nc" id="L323">            pstmt.setString(1, project.getTitle());</span>
<span class="nc" id="L324">            pstmt.setString(2, project.getDescription());</span>
<span class="nc" id="L325">            pstmt.setString(3, project.getTypeOfWork().toString());</span>
<span class="nc" id="L326">            pstmt.setString(4, project.getAffectedNeighbourhood());</span>
<span class="nc" id="L327">            pstmt.setString(5, project.getAffectedStreets());</span>
<span class="nc" id="L328">            pstmt.setString(6, project.getStartDate());</span>
<span class="nc" id="L329">            pstmt.setString(7, project.getEndDate());</span>
<span class="nc" id="L330">            pstmt.setString(8, project.getWorkSchedule());</span>
<span class="nc" id="L331">            pstmt.setString(9, project.getWorkStatus().toString());</span>
<span class="nc" id="L332">            pstmt.setString(10, project.getId()); // Ensure the correct project is updated</span>

<span class="nc" id="L334">            int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (rowsAffected == 0) {</span>
<span class="nc" id="L336">                System.out.println(&quot;Aucun projet mis à jour. ID invalide ou inexistant.&quot;);</span>
            } else {
<span class="nc" id="L338">                System.out.println(&quot;Projet mis à jour avec succès.&quot;);</span>
            }
<span class="nc" id="L340">        } catch (SQLException e) {</span>
<span class="nc" id="L341">            System.out.println(&quot;Erreur lors de la mise à jour du projet : &quot; + e.getMessage());</span>
<span class="nc" id="L342">        }</span>
<span class="nc" id="L343">    }</span>

    /**
     * Enregistre une requête de travaux dans la base de données locale.
     *
     * @param workRequestForm La requête à enregistrer.
     */
    public void saveWorkRequest(WorkRequestForm workRequestForm) {
<span class="fc" id="L351">        String insertSQL = &quot;INSERT INTO WorkRequests(id, submitter_id, title, description, project_type, expected_date) &quot; +</span>
                &quot;VALUES (?, ?, ?, ?, ?, ?)&quot;;

<span class="fc" id="L354">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="fc" id="L355">             PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {</span>
<span class="fc" id="L356">            pstmt.setString(1, workRequestForm.getId());</span>
<span class="fc" id="L357">            pstmt.setString(2, workRequestForm.getSubmitterId());</span>
<span class="fc" id="L358">            pstmt.setString(3, workRequestForm.getTitle());</span>
<span class="fc" id="L359">            pstmt.setString(4, workRequestForm.getDescription());</span>
<span class="fc" id="L360">            pstmt.setString(5, workRequestForm.getProjectType().toString());</span>
<span class="fc" id="L361">            pstmt.setString(6, workRequestForm.getExpectedDate());</span>

<span class="fc" id="L363">            pstmt.executeUpdate();</span>
            //System.out.println(&quot;La requête a été sauvegardée.&quot;); // Message helper
<span class="nc" id="L365">        } catch (SQLException e) {</span>
<span class="nc" id="L366">            System.out.println(&quot;Erreur lors de l'enregistrement de la requête : &quot; + e.getMessage());</span>
<span class="fc" id="L367">        }</span>
<span class="fc" id="L368">    }</span>

    /**
     * Met à jour une requête de travaux existante dans la base de données locale.
     *
     * @param workRequestForm La requête à mettre à jour.
     */
    public void updatingCandidacySubmission(WorkRequestForm workRequestForm) {
<span class="nc" id="L376">        String updateSQL = &quot;UPDATE WorkRequests SET submitter_id = ?, title = ?, description = ?, project_type = ?, &quot; +</span>
                &quot;expected_date = ?, submissions = ?, chosen_intervenant = ?, closing_message = ? WHERE id = ?&quot;;

<span class="nc" id="L379">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="nc" id="L380">             PreparedStatement pstmt = conn.prepareStatement(updateSQL)) {</span>

<span class="nc" id="L382">            pstmt.setString(1, workRequestForm.getSubmitterId());</span>
<span class="nc" id="L383">            pstmt.setString(2, workRequestForm.getTitle());</span>
<span class="nc" id="L384">            pstmt.setString(3, workRequestForm.getDescription());</span>
<span class="nc" id="L385">            pstmt.setString(4, workRequestForm.getProjectType().toString());</span>
<span class="nc" id="L386">            pstmt.setString(5, workRequestForm.getExpectedDate());</span>
<span class="nc" id="L387">            pstmt.setString(6, String.join(&quot;,&quot;, workRequestForm.getSubmissions()));</span>
<span class="nc" id="L388">            pstmt.setString(7, workRequestForm.getChosenIntervenant());</span>
<span class="nc" id="L389">            pstmt.setString(8, workRequestForm.getClosingMessage());</span>
<span class="nc" id="L390">            pstmt.setString(9, workRequestForm.getId()); // Ensure the correct project is updated</span>

<span class="nc" id="L392">            int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (rowsAffected == 0) {</span>
<span class="nc" id="L394">                System.out.println(&quot;Aucune requête mise à jour. ID invalide ou inexistant.&quot;);</span>
            } else {
<span class="nc" id="L396">                System.out.println(&quot;Requête mise à jour avec succès.&quot;);</span>
            }
<span class="nc" id="L398">        } catch (SQLException e) {</span>
<span class="nc" id="L399">            System.out.println(&quot;Erreur lors de la mise à jour du projet : &quot; + e.getMessage());</span>
<span class="nc" id="L400">        }</span>
<span class="nc" id="L401">    }</span>

    /**
     * Récupère toutes les requêtes soumises par un utilisateur spécifique.
     *
     * @param userId L'identifiant de l'utilisateur.
     * @return Une liste de {@code WorkRequestForm} représentant les requêtes de l'utilisateur.
     */
    public List&lt;WorkRequestForm&gt; fetchWorkRequestsByUserId(String userId) {
<span class="nc" id="L410">        List&lt;WorkRequestForm&gt; userWorkRequests = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L411">        String selectSQL = &quot;SELECT * FROM WorkRequests WHERE submitter_id = ?&quot;;</span>

<span class="nc" id="L413">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="nc" id="L414">             PreparedStatement pstmt = conn.prepareStatement(selectSQL)) {</span>
<span class="nc" id="L415">            pstmt.setString(1, userId);</span>

<span class="nc" id="L417">            try (ResultSet rs = pstmt.executeQuery()) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L419">                    String id = rs.getString(&quot;id&quot;);</span>
<span class="nc" id="L420">                    String submitterId = rs.getString(&quot;submitter_id&quot;);</span>
<span class="nc" id="L421">                    String title = rs.getString(&quot;title&quot;);</span>
<span class="nc" id="L422">                    String description = rs.getString(&quot;description&quot;);</span>
<span class="nc" id="L423">                    String projectType = rs.getString(&quot;project_type&quot;);</span>
<span class="nc" id="L424">                    String expectedDate = rs.getString(&quot;expected_date&quot;);</span>
<span class="nc" id="L425">                    String submissions = rs.getString(&quot;submissions&quot;);</span>
<span class="nc" id="L426">                    String chosenIntervenant = rs.getString(&quot;chosen_intervenant&quot;);</span>
<span class="nc" id="L427">                    String closingMessage = rs.getString(&quot;closing_message&quot;);</span>

<span class="nc" id="L429">                    WorkRequestForm workRequestForm = new WorkRequestForm(</span>
                            id,
                            submitterId,
                            title,
                            description,
                            projectType,
                            expectedDate,
<span class="nc bnc" id="L436" title="All 2 branches missed.">                            submissions != null ? Arrays.asList(submissions.split(&quot;,(?! )&quot;)) : new ArrayList&lt;&gt;(),</span>
                            chosenIntervenant,
                            closingMessage
                    );
<span class="nc" id="L440">                    userWorkRequests.add(workRequestForm);</span>
<span class="nc" id="L441">                }</span>
            }
<span class="nc" id="L443">        } catch (SQLException e) {</span>
<span class="nc" id="L444">            System.out.println(&quot;Erreur lors de la récupération des requêtes utilisateur : &quot; + e.getMessage());</span>
<span class="nc" id="L445">        }</span>
<span class="nc" id="L446">        return userWorkRequests;</span>
    }

    /**
     * Récupère toutes les requêtes de travaux depuis la base de données locale.
     *
     * @return Une liste de {@code WorkRequestForm} représentant les requêtes de travaux.
     */
    public List&lt;WorkRequestForm&gt; fetchWorkRequests() {
<span class="fc" id="L455">        List&lt;WorkRequestForm&gt; workRequestForms = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L456">        String selectSQL = &quot;SELECT * FROM WorkRequests&quot;;</span>
<span class="fc" id="L457">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="fc" id="L458">             PreparedStatement pstmt = conn.prepareStatement(selectSQL)) {</span>

<span class="fc" id="L460">            try (ResultSet rs = pstmt.executeQuery()) {</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L462">                    String idFromDb = rs.getString(&quot;id&quot;);</span>
<span class="fc" id="L463">                    String submitterIdFromDB = rs.getString(&quot;submitter_id&quot;);</span>
<span class="fc" id="L464">                    String titleFromDB = rs.getString(&quot;title&quot;);</span>
<span class="fc" id="L465">                    String descriptionFromDB = rs.getString(&quot;description&quot;);</span>
<span class="fc" id="L466">                    String projectTypeFromDB = rs.getString(&quot;project_type&quot;);</span>
<span class="fc" id="L467">                    String expectedDateFromDB = rs.getString(&quot;expected_date&quot;);</span>
<span class="fc" id="L468">                    String submissionsFromDB = rs.getString(&quot;submissions&quot;);</span>
<span class="fc" id="L469">                    String chosenIntervenantFromDB = rs.getString(&quot;chosen_intervenant&quot;);</span>
<span class="fc" id="L470">                    String closingMessageFromDB = rs.getString(&quot;closing_message&quot;);</span>

<span class="fc" id="L472">                    WorkRequestForm workRequestForm = new WorkRequestForm(</span>
                            idFromDb,
                            submitterIdFromDB,
                            titleFromDB,
                            descriptionFromDB,
                            projectTypeFromDB,
                            expectedDateFromDB,
<span class="fc bfc" id="L479" title="All 2 branches covered.">                            submissionsFromDB != null ? Arrays.asList(submissionsFromDB.split(&quot;,(?! )&quot;)) : new ArrayList&lt;&gt;(),</span>
                            chosenIntervenantFromDB,
                            closingMessageFromDB

                    );
<span class="fc" id="L484">                    workRequestForms.add(workRequestForm);</span>
<span class="fc" id="L485">                }</span>

<span class="pc bpc" id="L487" title="1 of 2 branches missed.">                if (workRequestForms.isEmpty()) {</span>
<span class="nc" id="L488">                    System.out.println(&quot;Erreur lors du fetching.&quot;);</span>
<span class="nc" id="L489">                    return null;</span>
                }

<span class="fc" id="L492">                return workRequestForms;</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L495">            System.out.println(&quot;Erreur lors de la connexion à la DB : &quot; + e.getMessage());</span>
<span class="nc" id="L496">            return null;</span>
        }
    }

    /**
     * Supprime une requête de travaux de la base de données locale.
     *
     * @param workRequestId L'identifiant unique de la requête à supprimer.
     */
    public void deleteWorkRequest(String workRequestId) {
<span class="nc" id="L506">        String deleteSQL = &quot;DELETE FROM WorkRequests WHERE id = ?&quot;;</span>
<span class="nc" id="L507">        try (Connection conn = DatabaseConnectionManager.getInstance().getConnection();</span>
<span class="nc" id="L508">             PreparedStatement pstmt = conn.prepareStatement(deleteSQL)) {</span>

<span class="nc" id="L510">            pstmt.setString(1, workRequestId); // Bind the work request ID to the query</span>
<span class="nc" id="L511">            int rowsAffected = pstmt.executeUpdate();</span>

<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L514">                System.out.println(&quot;Requête supprimée avec succès.&quot;);</span>
            } else {
<span class="nc" id="L516">                System.out.println(&quot;Aucune requête trouvée avec cet identifiant.&quot;);</span>
            }
<span class="nc" id="L518">        } catch (SQLException e) {</span>
<span class="nc" id="L519">            throw new RuntimeException(&quot;Erreur lors de la suppression de la requête : &quot; + e.getMessage());</span>
<span class="nc" id="L520">        }</span>
<span class="nc" id="L521">    }</span>


    // ##################### Classes utilisées pour le casting avec Mochi's Adapters #####################
    // Classe ApiResponse pour le Json au complet
<span class="fc" id="L526">    public static class ApiResponse {</span>
        public Result result;
    }

    // Classe Result pour l'objet &quot;result&quot;
<span class="fc" id="L531">    public static class Result {</span>
        @Json(name = &quot;records&quot;)
        public List&lt;Record&gt; records;

        // Classe Record pour l'objet &quot;records&quot; qui contient tous les projets en cours
<span class="fc" id="L536">        public static class Record {</span>
            // Travaux
            @Json(name = &quot;id&quot;)
            private String id;
            @Json(name = &quot;reason_category&quot;)
            private String typeOfWork;
            @Json(name = &quot;boroughid&quot;)
            private String affectedNeighbourhood;
            @Json(name = &quot;occupancy_name&quot;)
            private String affectedStreets;
            @Json(name = &quot;duration_start_date&quot;)
            private String startDate;
            @Json(name = &quot;duration_end_date&quot;)
            private String endDate;
            @Json(name = &quot;duration_days_mon_start_time&quot;)
            private String mondayStartTime;
            @Json(name = &quot;duration_days_mon_end_time&quot;)
            private String mondayEndTime;
            @Json(name = &quot;duration_days_tue_start_time&quot;)
            private String tuesdayStartTime;
            @Json(name = &quot;duration_days_tue_end_time&quot;)
            private String tuesdayEndTime;
            @Json(name = &quot;duration_days_wed_start_time&quot;)
            private String wednesdayStartTime;
            @Json(name = &quot;duration_days_wed_end_time&quot;)
            private String wednesdayEndTime;
            @Json(name = &quot;duration_days_thu_start_time&quot;)
            private String thursdayStartTime;
            @Json(name = &quot;duration_days_thu_end_time&quot;)
            private String thursdayEndTime;
            @Json(name = &quot;duration_days_fri_start_time&quot;)
            private String fridayStartTime;
            @Json(name = &quot;duration_days_fri_end_time&quot;)
            private String fridayEndTime;
            @Json(name = &quot;duration_days_sat_start_time&quot;)
            private String saturdayStartTime;
            @Json(name = &quot;duration_days_sat_end_time&quot;)
            private String saturdayEndTime;
            @Json(name = &quot;duration_days_sun_start_time&quot;)
            private String sundayStartTime;
            @Json(name = &quot;duration_days_sun_end_time&quot;)
            private String sundayEndTime;

            // Entraves
            @Json(name = &quot;id_request&quot;)
            private String idRequest;
            @Json(name = &quot;streetid&quot;)
            private String streetId;
            @Json(name = &quot;streetimpactwidth&quot;)
            private String streetImpactWidth;
            @Json(name = &quot;streetimpacttype&quot;)
            private String streetImpactType;

            public TypeOfWork getTypeOfWork() {
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">                if (typeOfWork != null) {</span>
                    // Matching partielle dans typeOfWork
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">                    if (typeOfWork.contains(&quot;souterraine&quot;)) {</span>
<span class="nc" id="L593">                        return TypeOfWork.UNDERGROUND;</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">                    } else if (typeOfWork.contains(&quot;routier&quot;)) {</span>
<span class="fc" id="L595">                        return TypeOfWork.ROAD;</span>
<span class="pc bpc" id="L596" title="2 of 4 branches missed.">                    } else if (typeOfWork.contains(&quot;gaz&quot;) || typeOfWork.contains(&quot;électricité&quot;)) {</span>
<span class="nc" id="L597">                        return TypeOfWork.GAS_ELECTRICITY;</span>
<span class="pc bpc" id="L598" title="1 of 4 branches missed.">                    } else if (typeOfWork.contains(&quot;construction&quot;) || typeOfWork.contains(&quot;rénovation&quot;)) {</span>
<span class="fc" id="L599">                        return TypeOfWork.CONSTRUCTION_RENOVATION;</span>
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">                    } else if (typeOfWork.contains(&quot;paysagement&quot;)) {</span>
<span class="nc" id="L601">                        return TypeOfWork.LANDSCAPE;</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">                    } else if (typeOfWork.contains(&quot;transports publics&quot;)) {</span>
<span class="nc" id="L603">                        return TypeOfWork.PUBLIC_TRANSPORT;</span>
<span class="pc bpc" id="L604" title="1 of 4 branches missed.">                    } else if (typeOfWork.contains(&quot;signalisation&quot;) || typeOfWork.contains(&quot;éclairage&quot;)) {</span>
<span class="fc" id="L605">                        return TypeOfWork.SIGNAGE_LIGHTING;</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">                    } else if (typeOfWork.contains(&quot;résidentiels&quot;)) {</span>
<span class="nc" id="L607">                        return TypeOfWork.RESIDENTIAL;</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">                    } else if (typeOfWork.contains(&quot;Entretien&quot;)) {</span>
<span class="fc" id="L609">                        return TypeOfWork.URBAN_MAINTENANCE;</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">                    } else if (typeOfWork.contains(&quot;télécommunication&quot;)) {</span>
<span class="nc" id="L611">                        return TypeOfWork.TELECOMMUNICATION_NETWORKS;</span>
                    }
                }

<span class="fc" id="L615">                return TypeOfWork.OTHER;</span>
            }

            public List&lt;String&gt; buildScheduleList() {
<span class="fc" id="L619">                List&lt;String&gt; scheduleList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L620">                scheduleList.add(formatTimeRange(saturdayStartTime, saturdayEndTime));  // Saturday</span>
<span class="fc" id="L621">                scheduleList.add(formatTimeRange(sundayStartTime, sundayEndTime));      // Sunday</span>
<span class="fc" id="L622">                scheduleList.add(formatTimeRange(mondayStartTime, mondayEndTime));      // Monday</span>
<span class="fc" id="L623">                scheduleList.add(formatTimeRange(tuesdayStartTime, tuesdayEndTime));    // Tuesday</span>
<span class="fc" id="L624">                scheduleList.add(formatTimeRange(wednesdayStartTime, wednesdayEndTime));// Wednesday</span>
<span class="fc" id="L625">                scheduleList.add(formatTimeRange(thursdayStartTime, thursdayEndTime));  // Thursday</span>
<span class="fc" id="L626">                scheduleList.add(formatTimeRange(fridayStartTime, fridayEndTime));      // Friday</span>
<span class="fc" id="L627">                return scheduleList;</span>
            }

            private String formatTimeRange(String startTime, String endTime) {
<span class="fc bfc" id="L631" title="All 2 branches covered.">                String formattedStartTime = (startTime != null) ? startTime : &quot;N/A&quot;;</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">                String formattedEndTime = (endTime != null) ? endTime : &quot;N/A&quot;;</span>
<span class="fc" id="L633">                return formattedStartTime + &quot;-&quot; + formattedEndTime;</span>
            }

            // Getters pour travaux
<span class="fc" id="L637">            public String getId() { return id; }</span>
<span class="fc" id="L638">            public String getTypeOfWorkRaw() { return this.typeOfWork; }</span>
<span class="fc" id="L639">            public String getAffectedNeighbourhood() { return affectedNeighbourhood; }</span>
<span class="fc" id="L640">            public String getAffectedStreets() { return affectedStreets; }</span>
<span class="fc" id="L641">            public String getStartDate() { return startDate; }</span>
<span class="fc" id="L642">            public String getEndDate() { return endDate; }</span>

            // Getters pour entraves
<span class="nc" id="L645">            public String getIdRequest() { return idRequest; }</span>
<span class="nc" id="L646">            public String getStreetId() { return streetId; }</span>
<span class="nc" id="L647">            public String getStreetImpactWidth() { return streetImpactWidth; }</span>
<span class="nc" id="L648">            public String getStreetImpactType() { return streetImpactType; }</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>